@page "/profile/changepassword"
@inject NavigationManager NavManager
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<div id="profile-background">
    <div id="profile-bar" class="m-x-5 w-75 bg-white rounded-3 m-5 d-lg-flex flex-row justify-content-between p-1 flex-nowrap">
        <div class="w-25 p-1 d-flex align-items-center justify-content-center flex-nowrap">
            <img id="profile-img" src="@GetProfilePhoto()" />
        </div>
        <div class="p-1 d-flex flex-column align-items-center justify-content-center text-end flex-nowrap">
            <p class="m-0">@GetUserName()</p>
            <h2 class="m-0">@GetName()</h2>

            <p class="m-0">@GetAccountType() Account</p>
        </div>
    </div>
    <div id="profile-body-container" class="m-x-5 w-100 bg-white rounded-profile p-3">
        <div id="profile-description-container">
            <h2 class="text-center fw-bold">Change Password:</h2>
            <div id="profile-edit-container" class="justify-content-center text-center">

                <EditForm Model="@passForm" OnSubmit="@SubmitNewPass">
                    <InputText id="old-pass" class="d-block mb-2" placeholder="Old Password" @bind-Value="passForm.oldPassword" />
                    <InputText id="new-pass" class="d-block mb-2" placeholder="New Password" @bind-Value="passForm.newPassword" />
                    <InputText id="retype-new-pass" class="d-block mb-2" placeholder="Retype New Password" @bind-Value="passForm.retypedPassword" />

                    <button type="submit">Submit</button>
                </EditForm>
                @if (errors.Count > 0)
                {
                    <ul class="text-danger">
                        @foreach (var error in errors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
</div>


@code {
    private List<string> errors = new();

    private string GetAccountType()
    {
        Data.MySQLDB db = new Data.MySQLDB();
        return db.GetAccountType(Convert.ToInt32(userId));
    }

    private string GetName()
    {
        Data.MySQLDB db = new Data.MySQLDB();

        return db.GetName(Convert.ToInt32(userId));
    }

    private string GetUserName()
    {
        Data.MySQLDB db = new Data.MySQLDB();

        return "@" + db.GetUserName(Convert.ToInt32(userId));
    }

    Data.ProfilePasswordForm passForm = new Data.ProfilePasswordForm();

    private string GetProfilePhoto()
    {

        Data.MySQLDB db = new Data.MySQLDB();
        string photoName = db.GetProfilePhoto(Convert.ToInt32(userId));
        Console.WriteLine(photoName);
        string src = $"userphotos\\{photoName}";
        return src;
    }

    private void SubmitNewPass()
    {
        Data.MySQLDB db1 = new Data.MySQLDB();
        if (passForm.oldPassword == db1.GetPassword(Convert.ToInt32(userId)))
        {
            if (passForm.newPassword == passForm.retypedPassword)
            {
                if (passForm.newPassword == "" || passForm.newPassword == null)
                {
                    errors.Add($"Error: Username cannot be empty");
                    return;
                }
                else
                {
                    Data.MySQLDB db2 = new Data.MySQLDB();

                    db2.UpdatePassword(passForm.newPassword, Convert.ToInt32(userId));
                    //On Success
                    NavManager.NavigateTo("/profile");
                }

            }
            else
            {
                errors.Add($"Error: retyped new password does not match");
                return;
            }
        }
        else
        {
            errors.Add($"Error: old password incorrect");
            return;
        }


    }

    string userId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await GetSessionUser();
        StateHasChanged();
    }

    private async Task GetSessionUser()
    {
        userId = await sessionStorage.GetItemAsync<String>("userId");
    }
}
